<!DOCTYPE html>
<input>
<head>
    <title>Facebook Web Data Connector</title>
    <meta charset="UTF-8">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
    <script src="../WebDataConnector_sdk/js/tableauwdc-1.1.0.js" type="text/javascript"></script>
</head>
<>
<script>
    var DEFAULT_CLIENT_ID = '107253586284463'; // My App ID
    //var DEFAULT_CLIENT_ID = "475960835902299"; // This is Samm's personal app id
    //var DEFAULT_CLIENT_ID = "131331403865338"; // This is the the Tableau id that Francois put in
    var DEFAULT_REQUESTED_SCOPE = 'user_status,user_likes,user_posts';
    var FACEBOOK_OAUTH = 'https://www.facebook.com/dialog/oauth';

    (function(ns) {
        $(function() {
            $('fbAppId').val(DEFAULT_CLIENT_ID);
            $('fbAppScope').val(DEFAULT_REQUESTED_SCOPE);
        });



        function login() {
            var fbAppId = $('fbAppId').val();
            var fbAppScope = $('fbAppScope').val();

            var oauthParams = {
                response_type : 'token',
                client_id     : fbAppId,
                redirect_uri  : window.location.href,
                scope         : fbAppScope
            };

            var fbAuthURL = FACEBOOK_OAUTH + '?' + $.param(oauthParams);

            window.location.href = fbAuthURL;
        }

        function setupLoginButton(actionText) {
            $('<a id="loginLink" href="#">Login!</a>').appendTo('body');
            $('#loginLink').on('click', login);

            if(actionText) {
                $('<div>').text(actionText).appendTo('body');
            }
        }

        // This is called with the results from from FB.getLoginStatus().
        function statusChangeCallback(response) {
            if (response.status === 'connected') {
                testAPI();
            } else if (response.status === 'not_authorized') {
                setupLoginButton('Please log into this app.');
            } else {
                setupLoginButton('Please log into Facebook.');
            }
        }

        window.fbAsyncInit = function() {
            FB.init({
                appId   : DEFAULT_CLIENT_ID,
                cookie  : true,  // enable cookies to allow the server to access the session
                xfbml   : false, // parse social plugins on this page is not needed
                version : 'v2.2' // use version 2.2
            });

            FB.getLoginStatus(statusChangeCallback);
        };

        // Load the SDK asynchronously
        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // Here we run a very simple test of the Graph API after login is
        // successful.  See statusChangeCallback() for when this call is made.
        function testAPI() {
            console.log('Welcome!  Fetching your information.... ');
            FB.api('/me', function(response) {
                console.log('Successful login for: ' + response.name);
                $('<div>').text('Thanks for logging in, ' + response.name + '!').appendTo('body');
            });

            FB.api('/me/feed', function(response) {
                console.log('Feed: ' + JSON.stringify(response, null, 2));
            });
        }

        var DETAIL_APIS = {
            '/me': {
                headers: {
                    first_name   : tableau.FIELD_TYPE.string,
                    gender       : tableau.FIELD_TYPE.string,
                    id           : tableau.FIELD_TYPE.string,
                    last_name    : tableau.FIELD_TYPE.string,
                    link         : tableau.FIELD_TYPE.string,
                    locale       : tableau.FIELD_TYPE.string,
                    name         : tableau.FIELD_TYPE.string,
                    timezone     : tableau.FIELD_TYPE.int,
                    updated_time : tableau.FIELD_TYPE.datetime,
                    verified     : tableau.FIELD_TYPE.bool
                },
                handleResponse: function(resp) {
                    return resp;
                }
            }
        };

        var LIST_APIS = {
            '/me/feed': {
                apiPath: '/feed',
                headers: {

                },
                handleResponse: function(resp) {
                    return resp;
                }
            },

        };

        function buildError(requestPath, fbError) {
            /*
            var fbError =  {
                "message": "(#15) This method is only accessible to Games.",
                "type": "OAuthException",
                "code": 15
            }
            */

            return 'Error calling "' + requestPath + '", ' + fbError.type + ' (' + fbError.code + '): ' + fbError.message;
        }

        function fbRequest(requestPath, dataCB, errorCB) {
            FB.api(requestPath, function(response) {
                if (response.error) {
                    errorCB(buildError(requestPath, response.error))
                    return;
                }

                dataCB(response.data);
            });
        }

        var friends = {
            headers: {
                'ID':   tableau.FIELD_TYPE.string,
                'Name': tableau.FIELD_TYPE.string
            },
            path: '/me/friends',
            transformRow: function(friend) {
                return {
                    'ID':   friend.id,
                    'Name': friend.name
                };
            }
        };

        function rowJoin() {
            if(arguments.length === 0) return [];

            var joinedRows = [{}]; // Add empty so we have a single element to merge the first row against

            $.each(arguments, function(i, rows) {

                var localJoinedRows = [];

                [].concat(rows).forEach(function(row) {
                    localJoinedRows.concat(joinedRows.map(function(currentJoinedRow) {
                        return $.extend({}, currentJoinedRow, row);
                    }));
                });
            });

            return joinedRows;
        }

        var feed = {
            headers: {
                'ID':        tableau.FIELD_TYPE.string,
                'From ID':   tableau.FIELD_TYPE.string,
                'From Name': tableau.FIELD_TYPE.string
            },
            path: '/me/feed',
            transformRow: function(post) {
                // TODO: Figure out how to do a row join

                return {
                    'ID': post.id,
                    'From ID': post.from.id,
                    'From Name': post.from.name,
                    'Message': post.message,
                    'Story': post.story,
                    'Picture': post.picture,
                    'Link': post.link,
                    'Icon': post.icon,
                    'Privacy Value': post.privacy.value,
                    'Privacy Description': post.privacy.description,
                    'Privacy Friends': post.privacy.friends,
                    'Privacy Allow': post.privacy.allow,
                    'Privacy Deny': post.privacy.deny,
                    'Type': post.type,
                    'Status Type': post.status_type,
                    'Object ID': post.object_id,
                    'Application Name': post.application.name,
                    'Application ID': post.application.id,
                    'Created Time': post.created_time, //datetime
                    'Updated Time': post.updated_time, //datetime
                    'Is Hidden': post.is_hidden, //bool
                    'Subscribed': post.subscribed, //bool
                    'Is Expired': post.is_expired, //bool
                };
            }
        };

        var inbox = {
            headers: {
                'ID':   tableau.FIELD_TYPE.string,
                'Name': tableau.FIELD_TYPE.string
            },
            path: '/me/inbox',
            transformRow: function(friend) {
                return {
                    'ID':   friend.id,
                    'Name': friend.name
                };
            }
        };


        //////////////////////////////////////////////////////////////////////////////////
        // Set up connector
        //////////////////////////////////////////////////////////////////////////////////

        function setConnector(fbConfig) {
            var myConnector = tableau.makeConnector();

            var fieldNames = Object.keys(fbConfig.headers); // Extract field name
            var fieldTypes = fieldNames.forEach(function(fieldName) { return fbConfig.headers[fieldName]; }); // Extract type from the value

            myConnector.getColumnHeaders = function() {
                tableau.headersCallback(fieldNames, fieldTypes);
            };

            myConnector.getTableData = function(lastRecordToken) {
                fbRequest(
                    fbConfig.path,
                    function(data) { tableau.dataCallback(data.map(fbConfig.transformRow.bind(fbConfig))); }, // TODO: Improve this
                    tableau.abortWithError
                );
            };
        }

        var myConnector = tableau.makeConnector();

        // TODO: Is this complex logic needed?
        //myConnector.init = function() {

    })(window);

</script>


<table>
    <tr>
        <td>App ID:</td>
        <td><input type="text" id="fbAppId"></input></td>
    </tr>
    <tr>
        <td>App Scope:</td>
        <td><input type="text" id="fbAppScope"></input></td>
    </tr>
</table>

</body>
</html>